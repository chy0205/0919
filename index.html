<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å´‡è¯åäº”æœŸèª²å ‚æ¸¬é©—</title>
    <!-- å¼•å…¥ Tailwind CSS CDNï¼Œä»¥ä¾¿é€²è¡Œç¾ä»£åŒ–æ¨£å¼å¾®èª¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¤æ¨£å¼è¦†è“‹èˆ‡å­—é«”è¨­å®š */
        body {
            font-family: 'æ¨™æ¥·é«”', 'BiauKai', serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f6;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px 40px;
            border-radius: 12px; /* ç¨å¾®æ›´åœ“æ½¤ */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            font-size: 2.5em;
            color: #4CAF50;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .section h2 {
            font-size: 1.8em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
            color: #555;
        }
        .question {
            margin-bottom: 25px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px; /* ç¨å¾®æ›´åœ“æ½¤ */
            background-color: #fafafa;
            transition: box-shadow 0.3s;
        }
        .question:hover {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .options label {
            display: flex; /* ä½¿ç”¨ flex æ’ç‰ˆé¸é …å’Œ input */
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.3s, transform 0.1s;
        }
        .options label:hover {
            background-color: #e9e9e9;
        }
        .options input {
            margin-right: 10px;
            transform: scale(1.2); /* è®“é¸é …æ›´å®¹æ˜“é»é¸ */
        }
        .correct {
            color: #388e3c;
            font-weight: bold;
        }
        .incorrect {
            color: #d32f2f;
            font-weight: bold;
        }
        .result-box {
            text-align: center;
            margin-top: 30px;
            padding: 30px;
            border-radius: 12px;
            background-color: #e8f5e9;
            border: 3px solid #4CAF50;
        }
        #result {
            font-size: 2.5em;
            color: #388e3c;
            margin: 10px 0;
        }
        /* æŒ‰éˆ•åŸºç¤æ¨£å¼å„ªåŒ– */
        button {
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
            box-shadow: 0 4px #388e3c;
            margin: 5px;
        }
        button:hover:not(:disabled) {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px #388e3c;
        }
        button:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px #388e3c;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        .fill-in-the-blank {
            width: 90%;
            max-width: 300px;
            border: 2px solid #ccc;
            padding: 8px;
            border-radius: 5px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .fill-in-the-blank:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }
        /* æ–°å¢è¨Šæ¯é€šçŸ¥æ¨£å¼ */
        #message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-20px);
        }
        .message-success {
            background-color: #4CAF50;
        }
        .message-error {
            background-color: #f44336;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header text-center">
            <h1>å´‡è¯åäº”æœŸèª²å ‚æ¸¬é©—</h1>
        </div>

        <div id="selection-container" class="selection-container flex flex-col items-center">
            <h2 class="text-xl font-bold mb-4">è«‹å…ˆé¸æ“‡ä½ çš„è€ƒå·ã€çµ„åˆ¥èˆ‡å§“å</h2>
            <select id="quiz-type-select" class="p-2 mb-4 rounded border border-gray-300 w-full max-w-xs">
                <option value="" disabled selected>è«‹é¸æ“‡ç¶“å…¸ç§‘ç›®</option>
                <option value="è«–èª">è«–èª</option>
                <option value="æ€§ç†">æ€§ç†</option>
                <option value="é“å¾·ç¶“">é“å¾·ç¶“</option>
                <option value="å…­ç¥–">å…­ç¥–</option>
            </select>
            <select id="group-select" disabled class="p-2 mb-4 rounded border border-gray-300 w-full max-w-xs">
                <option value="" disabled selected>è«‹é¸æ“‡çµ„åˆ¥</option>
            </select>
            <select id="name-select" disabled class="p-2 mb-4 rounded border border-gray-300 w-full max-w-xs">
                <option value="" disabled selected>è«‹é¸æ“‡å§“å</option>
            </select>
            <button id="start-btn" onclick="startQuiz()" disabled>é–‹å§‹æ¸¬é©—</button>
        </div>
        
        <div id="quiz-container" style="display:none;">
            <!-- æ¸¬é©—é¡Œç›®å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <div class="button-group text-center" style="display:none;">
            <button id="submit-btn" onclick="calculateScore()">é€å‡ºç­”æ¡ˆ</button>
            <!-- ç”±æ–¼æˆ‘å€‘ä½¿ç”¨å–®ä¸€é€å‡ºæŒ‰éˆ•ä¾†è©•åˆ†ä¸¦å‚³é€ï¼Œæ•…ç„¡éœ€å…¶ä»–æŒ‰éˆ• -->
        </div>

        <div class="result-box" style="display:none;">
            <h2>æ¸¬é©—çµæœ</h2>
            <p>è€ƒå·é¡å‹ï¼š<span id="quiz-type-result"></span></p>
            <p>çµ„åˆ¥ï¼š<span id="group-result"></span></p>
            <p>å§“åï¼š<span id="name-result"></span></p>
            <p>ä½ çš„å¾—åˆ†ï¼š<span id="score"></span> åˆ†</p>
            <p id="wrong-questions" style="color: #d32f2f; font-weight: bold;"></p>
            <div id="feedback"></div>
        </div>
    </div>

    <!-- è¨Šæ¯é€šçŸ¥æ¡† (å–ä»£ alert) -->
    <div id="message-box" role="alert"></div>

    <script>
        // è¨­å®š Firebase Log Level for debugging Firestore (å³ä½¿é€™è£¡æ²’ç”¨ Firestore ä¹Ÿæ˜¯å¥½ç¿’æ…£)
        // ç”±æ–¼é€™è£¡æ˜¯ç´” HTML/JSï¼Œæˆ‘å€‘ç„¡æ³•ä½¿ç”¨ setLogLevelï¼Œæ­¤è¡Œè¨»é‡‹æ‰ã€‚
        // console.log("æ³¨æ„: æ­¤æ‡‰ç”¨ç¨‹å¼ä¾è³´ Google è©¦ç®—è¡¨åŠ Apps Scriptï¼Œè«‹ç¢ºèªæ‰€æœ‰å¤–éƒ¨é€£çµçš„æ¬Šé™è¨­å®šã€‚");

        // API key will be provided by the environment
        const API_KEY = "";
        
        // *** é€™è£¡å¡«å…¥ä½ çš„ Google è©¦ç®—è¡¨ ID (åŒæ™‚åŒ…å«é¡Œç›®èˆ‡åå–®è³‡æ–™) ***
        const SPREADSHEET_ID = '1W8Y5buwLWAeFFU-ejxhez4He8qyUQsy2yQtlIq8wLBs';
        
        // *** é€™è£¡å¡«å…¥æ‚¨å­˜æ”¾ã€Œçµ„åˆ¥èˆ‡å§“åã€å·¥ä½œè¡¨çš„ gidï¼Œä¾‹å¦‚ï¼š123456789 ***
        const TEAMS_SHEET_GID = '1026036029';

        // *** è«‹å°‡é€™è£¡æ›¿æ›æˆä½ éƒ¨ç½²çš„ Google Apps Script ç¶²å€ ***
        // ç¢ºä¿æ­¤ç¶²å€ç‚ºå…¬é–‹åŸ·è¡Œçš„éƒ¨ç½²ï¼
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxLpuVRpQvNlV5c4b4q5ON8nOLL7FCEx0xhn3phE_8PNeRc2GbeZLNX-klVJC1tuQnM8A/exec';

        // *** è«‹å°‡é€™è£¡çš„ GID æ›¿æ›æˆæ‚¨å„å€‹æ¸¬é©—å·¥ä½œè¡¨çš„å¯¦éš› GID ***
        const QUIZ_GIDS = {
            'éš¨å ‚': '0',
            'è«–èª': '1250135497',
            'æ€§ç†': '1342680959',
            'é“å¾·ç¶“': '1246480043',
            'å…­ç¥–': '1302889740',
        };

        // é€™æ˜¯ Google è©¦ç®—è¡¨å…¬é–‹æŸ¥è©¢çš„ API ç¶²å€ï¼Œæœƒå°‡è³‡æ–™è½‰æˆ JSON æ ¼å¼
        const GOOGLE_SHEET_BASE_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=`;
        const TEAMS_SHEET_URL = `${GOOGLE_SHEET_BASE_URL}${TEAMS_SHEET_GID}`;

        // ç”¨ä¾†å­˜æ”¾å¾è©¦ç®—è¡¨è®€å–åˆ°çš„é¡Œç›®è³‡æ–™
        let quizData = [];
        const quizContainer = document.getElementById('quiz-container');
        const selectionContainer = document.getElementById('selection-container');
        const buttonGroup = document.querySelector('.button-group');
        let userAnswers = []; // ç”¨ä¾†å„²å­˜ä½¿ç”¨è€…çš„ç­”æ¡ˆ
        let selectedQuizType = '';
        let selectedGroup = '';
        let selectedName = '';
        let teamsData = {};

        // é¡¯ç¤ºå®¢è£½åŒ–è¨Šæ¯ (å–ä»£ alert)
        function showMessage(message, isError = false) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.className = isError ? 'message-box message-error' : 'message-box message-success';
            msgBox.style.display = 'block';
            
            // è§¸ç™¼ CSS å‹•ç•«
            setTimeout(() => {
                msgBox.style.opacity = '1';
                msgBox.style.transform = 'translateY(0)';
            }, 10); // 10ms å»¶é²ä»¥ç¢ºä¿å‹•ç•«ç”Ÿæ•ˆ

            setTimeout(() => {
                msgBox.style.opacity = '0';
                msgBox.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    msgBox.style.display = 'none';
                }, 300); // å‹•ç•«çµæŸå¾Œéš±è—
            }, 4000); // 4 ç§’å¾Œè‡ªå‹•é—œé–‰
        }

        // éš¨æ©Ÿæ‰“äº‚é™£åˆ—é †åºçš„å‡½å¼ï¼ˆFisher-Yates shuffleï¼‰
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // å¾ Google è©¦ç®—è¡¨è®€å–çµ„åˆ¥èˆ‡å§“åè³‡æ–™
        async function fetchTeamsData() {
            try {
                const response = await fetch(TEAMS_SHEET_URL);
                const text = await response.text();
                // è§£æ Google gviz è¼¸å‡ºçš„ JSON æ ¼å¼
                const jsonTextMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                if (!jsonTextMatch || jsonTextMatch.length < 2) {
                    throw new Error("ç„¡æ³•è§£æ Google è©¦ç®—è¡¨ JSON æ ¼å¼ã€‚");
                }
                const jsonText = jsonTextMatch[1];
                const data = JSON.parse(jsonText);

                teamsData = {};
                const rows = data.table.rows;
                // æ³¨æ„ï¼šé€™è£¡å‡è¨­ç¬¬ 1 è¡Œæ˜¯æ¨™é¡Œï¼Œæ‰€ä»¥æˆ‘å€‘ç›´æ¥éæ­·æ‰€æœ‰è¡Œï¼Œå¦‚æœç¬¬ä¸€è¡Œä¸æ˜¯è³‡æ–™ï¼Œæ‚¨çš„ Apps Script/è³‡æ–™çµæ§‹å¯èƒ½éœ€è¦èª¿æ•´
                rows.forEach(row => {
                    // row.c[0] æ˜¯çµ„åˆ¥ (Group)ï¼Œrow.c[1] æ˜¯å§“å (Name)
                    const group = row.c[0] && row.c[0].v ? row.c[0].v : null;
                    const name = row.c[1] && row.c[1].v ? row.c[1].v : null;
                    
                    // å¿½ç•¥è¡¨é ­æˆ–ç©ºè¡Œ (é€™è£¡å‡è¨­åªæœ‰å…©æ¬„è³‡æ–™)
                    if (group && name && group !== 'çµ„åˆ¥' && name !== 'å§“å') { 
                        if (!teamsData[group]) {
                            teamsData[group] = [];
                        }
                        teamsData[group].push(name);
                    }
                });
                
                populateGroups();
            } catch (error) {
                console.error('è¼‰å…¥çµ„åˆ¥èˆ‡å§“åè³‡æ–™å¤±æ•—:', error);
                selectionContainer.innerHTML = '<p style="color:red;">è¼‰å…¥çµ„åˆ¥è³‡æ–™å¤±æ•—ã€‚è«‹ç¢ºèªä½ çš„è©¦ç®—è¡¨ IDã€çµ„åˆ¥å·¥ä½œè¡¨ GID æ˜¯å¦æ­£ç¢ºï¼Œä¸¦å·²è¨­å®šç‚ºã€Œä»»ä½•çŸ¥é“é€£çµçš„äººéƒ½å¯ä»¥æª¢è¦–ã€ã€‚</p>';
            }
        }

        function populateGroups() {
            const groupSelect = document.getElementById('group-select');
            for (const group in teamsData) {
                const option = document.createElement('option');
                option.value = group;
                option.text = group;
                groupSelect.appendChild(option);
            }

            const quizTypeSelect = document.getElementById('quiz-type-select');
            quizTypeSelect.addEventListener('change', (e) => {
                selectedQuizType = e.target.value;
                groupSelect.disabled = false;
                checkStartButton();
            });

            groupSelect.addEventListener('change', (e) => {
                selectedGroup = e.target.value;
                populateNames(selectedGroup);
                checkStartButton();
            });
        }

        function populateNames(group) {
            const nameSelect = document.getElementById('name-select');
            nameSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å§“å</option>';
            selectedName = ''; // é‡ç½®å§“åé¸æ“‡
            if (teamsData[group]) {
                teamsData[group].forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.text = name;
                    nameSelect.appendChild(option);
                });
                nameSelect.disabled = false;
            } else {
                nameSelect.disabled = true;
            }

            nameSelect.addEventListener('change', (e) => {
                selectedName = e.target.value;
                checkStartButton();
            });
        }

        function checkStartButton() {
            const startBtn = document.getElementById('start-btn');
            if (selectedQuizType && selectedGroup && selectedName) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }

        function startQuiz() {
            selectionContainer.style.display = 'none';
            quizContainer.style.display = 'block';
            quizContainer.innerHTML = '<div class="loading-text">æ­£åœ¨å¾ Google è©¦ç®—è¡¨è¼‰å…¥é¡Œç›®...</div>';
            buttonGroup.style.display = 'none'; // è¼‰å…¥æ™‚å…ˆéš±è—é€å‡ºæŒ‰éˆ•
            fetchCombinedQuizData();
        }

        async function fetchQuizData(quizType) {
            try {
                const quizGid = QUIZ_GIDS[quizType];
                if (!quizGid) {
                    console.error(`æ‰¾ä¸åˆ°è€ƒå·é¡å‹ '${quizType}' å°æ‡‰çš„ GIDã€‚`);
                    return [];
                }
                const quizSheetUrl = `${GOOGLE_SHEET_BASE_URL}${quizGid}`;
                
                const response = await fetch(quizSheetUrl);
                const text = await response.text();
                // è§£æ Google gviz è¼¸å‡ºçš„ JSON æ ¼å¼
                const jsonTextMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                if (!jsonTextMatch || jsonTextMatch.length < 2) {
                    throw new Error("ç„¡æ³•è§£æ Google è©¦ç®—è¡¨ JSON æ ¼å¼ã€‚");
                }
                const jsonText = jsonTextMatch[1];
                const data = JSON.parse(jsonText);

                const questions = [];
                const rows = data.table.rows;
                // å‡è¨­æ¬„ä½é †åº: é¡Œç›®, é¡å‹, é¸é …, ç­”æ¡ˆ, åˆ†æ•¸, åœ–ç‰‡ç¶²å€ (æ¬„ä½ C[0]~C[5])
                rows.forEach(row => {
                    const cells = row.c;
                    const question = cells[0] && cells[0].v ? cells[0].v : '';
                    const type = cells[1] && cells[1].v ? cells[1].v.toLowerCase() : '';
                    const options = cells[2] && cells[2].v ? String(cells[2].v).split(',').map(item => item.trim()) : [];
                    const answerValue = cells[3] && cells[3].v !== undefined ? String(cells[3].v) : '';
                    const answer = answerValue ? answerValue.split(',').map(item => item.trim()) : [];
                    const score = cells[4] && cells[4].v ? parseFloat(cells[4].v) : 0;
                    const imageUrl = cells[5] && cells[5].v ? cells[5].v : '';
                    
                    if (question && ['single', 'multiple', 'fill'].includes(type) && answer.length > 0) {
                        questions.push({ question, type, options, answer, score, imageUrl });
                    }
                });
                return questions;

            } catch (error) {
                console.error(`è¼‰å…¥ '${quizType}' æ¸¬é©—è³‡æ–™å¤±æ•—:`, error);
                showMessage(`è¼‰å…¥ '${quizType}' æ¸¬é©—è³‡æ–™å¤±æ•—ã€‚è«‹æª¢æŸ¥ GIDã€‚`, true);
                return [];
            }
        }

        async function fetchCombinedQuizData() {
            // éš¨å ‚æ¸¬é©—æ˜¯å¿…è€ƒ
            const [mandatoryQuiz, optionalQuiz] = await Promise.all([
                fetchQuizData('éš¨å ‚'),
                fetchQuizData(selectedQuizType)
            ]);
            
            // === èª¿æ•´é‚è¼¯ï¼šä¿ç•™é¡Œç›®åœ¨è©¦ç®—è¡¨ä¸­çš„åŸå§‹é †åº (ä¸å†æ‰“äº‚é¡Œç›®é †åº) ===
            const orderedMandatory = mandatoryQuiz;
            const orderedOptional = optionalQuiz;

            // ä¾ä½¿ç”¨è€…è¦æ±‚ï¼Œå…ˆé¡¯ç¤ºéš¨å ‚é¡Œç›®ï¼Œå†é¡¯ç¤ºç¶“å…¸é¡Œç›®
            // æ¯ä¸€å¤§é¡å…§éƒ¨çš„é¡Œç›®ç¾åœ¨æ˜¯ä¾æ“šè©¦ç®—è¡¨ä¸­çš„åŸå§‹é †åº
            quizData = [...orderedMandatory, ...orderedOptional];
            // ==========================================================

            const quizTypeResult = document.getElementById('quiz-type-result');
            if (quizTypeResult) {
                quizTypeResult.innerText = `éš¨å ‚ + ${selectedQuizType}`;
            }

            if (quizData.length > 0) {
                renderQuiz();
            } else {
                quizContainer.innerHTML = '<div class="loading-text" style="color:#d32f2f;">ç„¡æ³•è¼‰å…¥é¡Œç›®ï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨IDæˆ–åˆ†äº«è¨­å®šã€‚</div>';
            }
        }


        function renderQuiz() {
            quizContainer.innerHTML = '';
            let quizHTML = '';

            quizData.forEach((item, index) => {
                const questionNumber = index + 1;
                let optionsHTML = '';
                // å–®é¸ (radio) æˆ–å¤šé¸ (checkbox)
                const inputType = item.type === 'single' ? 'radio' : 'checkbox';
                
                let imageHTML = '';
                if (item.imageUrl) {
                    const isDirectLink = /\.(jpg|jpeg|png|gif|svg|webp|tiff|bmp)$/i.test(item.imageUrl);
                    
                    if (isDirectLink) {
                        // åœ–ç‰‡è¼‰å…¥å¤±æ•—æ™‚ä½¿ç”¨ placeholder
                        imageHTML = `<img src="${item.imageUrl}" alt="é¡Œç›®åœ–ç‰‡" onerror="this.onerror=null; this.src='https://placehold.co/400x150/ffcccc/c00000?text=åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼'; this.style.border='2px dashed #c00000';" class="mt-4 mb-2">`;
                    } else {
                        // å¦‚æœç¶²å€çœ‹èµ·ä¾†ä¸æ˜¯åœ–ç‰‡ç›´é€£ï¼Œçµ¦äºˆæç¤º
                        imageHTML = `
                            <div style="background-color: #fcebeb; border: 1px solid #f2c7c7; padding: 10px; border-radius: 5px; text-align: center; margin-top: 10px;">
                                <p style="color: #c72c2c; font-weight: bold;">åœ–ç‰‡ç„¡æ³•é¡¯ç¤º</p>
                                <p style="font-size: 0.9em; margin: 5px 0;">æ‚¨è²¼ä¸Šçš„ç¶²å€ä¸æ˜¯åœ–ç‰‡æª”æ¡ˆæœ¬èº«ã€‚è«‹ä½¿ç”¨ä¸€å€‹åœ–ç‰‡ç›´é€£ç¶²å€ã€‚</p>
                            </div>
                        `;
                    }
                }

                if (item.type === 'single' || item.type === 'multiple') {
                    // æ‰“äº‚é¸é …é †åºï¼Œä»¥é¿å…èƒŒèª¦ (é€™éƒ¨åˆ†ä¿ç•™)
                    const shuffledOptions = shuffleArray([...item.options]);
                    shuffledOptions.forEach((option, optIndex) => {
                        optionsHTML += `
                            <label>
                                <input type="${inputType}" name="q${questionNumber}" value="${option}"> 
                                <span>${option}</span>
                            </label>`;
                    });
                    quizHTML += `
                        <div class="question" id="q${questionNumber}">
                            <p>${questionNumber}. ${item.question} <span style="font-size: 0.8em; color: #888;">(${item.score}åˆ†)</span></p>
                            ${imageHTML}
                            <div class="options">
                                ${optionsHTML}
                            </div>
                            <div class="answer-feedback mt-2"></div>
                        </div>
                    `;
                } else if (item.type === 'fill') {
                    quizHTML += `
                        <div class="question" id="q${questionNumber}">
                            <p>${questionNumber}. ${item.question} <span style="font-size: 0.8em; color: #888;">(${item.score}åˆ†)</span></p>
                            ${imageHTML}
                            <input type="text" class="fill-in-the-blank mt-2" id="q${questionNumber}_answer" placeholder="è«‹åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ">
                            <div class="answer-feedback mt-2"></div>
                        </div>
                    `;
                }
            });

            quizContainer.innerHTML = quizHTML;
            buttonGroup.style.display = 'block';
        }

        function calculateScore() {
            let userScore = 0;
            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.innerHTML = '';
            userAnswers = [];
            const wrongQuestions = [];
            
            quizData.forEach((item, index) => {
                const qId = `q${index + 1}`;
                const questionElement = document.getElementById(qId);
                
                if (!questionElement) {
                    console.error(`ç„¡æ³•æ‰¾åˆ° ID ç‚º ${qId} çš„é¡Œç›®å…ƒç´ ã€‚å·²è·³éã€‚`);
                    return;
                }

                const feedbackElement = questionElement.querySelector('.answer-feedback');
                let isCorrect = false;
                let userAnswerText = '';

                if (item.type === 'single') {
                    const userAnswer = document.querySelector(`input[name="${qId}"]:checked`);
                    userAnswerText = userAnswer ? userAnswer.value : 'æœªä½œç­”';
                    if (userAnswer && userAnswer.value === item.answer[0]) {
                        isCorrect = true;
                    }
                } else if (item.type === 'multiple') {
                    const userAnswersArr = Array.from(document.querySelectorAll(`input[name="${qId}"]:checked`)).map(el => el.value).sort();
                    // ç­”æ¡ˆå¿…é ˆå…¨éƒ¨å»åˆä¸”é †åºä¸€è‡´
                    const correctAnswersSorted = item.answer.sort();
                    userAnswerText = userAnswersArr.join(', ') || 'æœªä½œç­”';
                    if (userAnswersArr.length === correctAnswersSorted.length && 
                        JSON.stringify(userAnswersArr) === JSON.stringify(correctAnswersSorted)) {
                        isCorrect = true;
                    }
                } else if (item.type === 'fill') {
                    const userAnswerInput = document.getElementById(`${qId}_answer`);
                    // å¡«ç©ºé¡Œç­”æ¡ˆå¿½ç•¥å¤§å°å¯«å’Œå‰å¾Œç©ºç™½
                    const userAnswerNormalized = userAnswerInput ? userAnswerInput.value.trim() : 'æœªä½œç­”';
                    const correctAnswerNormalized = item.answer[0].trim();
                    userAnswerText = userAnswerNormalized;
                    if (userAnswerNormalized === correctAnswerNormalized) {
                        isCorrect = true;
                    }
                }

                if (isCorrect) {
                    userScore += item.score;
                    feedbackElement.innerHTML = `<span class="correct">âœ” æ­£ç¢º</span><span style="color:#888;"> (ç²å¾— ${item.score} åˆ†)</span>`;
                    questionElement.style.border = '1px solid #4CAF50';
                } else {
                    wrongQuestions.push(index + 1);
                    const correctAnswerText = item.answer.join(', ');
                    feedbackElement.innerHTML = `<span class="incorrect">âœ˜ éŒ¯èª¤</span>ã€‚æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<span class="correct">${correctAnswerText}</span>`;
                    questionElement.style.border = '1px solid #f44336';
                }
                
                userAnswers.push({
                    question: item.question,
                    userAnswer: userAnswerText,
                    correctAnswer: item.answer.join(', '),
                    isCorrect: isCorrect ? 'æ˜¯' : 'å¦'
                });
            });

            // ç¦ç”¨æ‰€æœ‰è¼¸å…¥å’Œé€å‡ºæŒ‰éˆ•
            const allInputs = document.querySelectorAll('#quiz-container input, #submit-btn');
            allInputs.forEach(input => {
                input.disabled = true;
            });
            document.getElementById('submit-btn').disabled = true;

            document.getElementById('quiz-type-result').innerText = `éš¨å ‚ + ${selectedQuizType}`;
            document.getElementById('group-result').innerText = selectedGroup;
            document.getElementById('name-result').innerText = selectedName;
            document.getElementById('score').innerText = userScore.toFixed(1); // é¡¯ç¤ºä¸€ä½å°æ•¸
            
            const wrongQuestionsElement = document.getElementById('wrong-questions');
            if (wrongQuestions.length > 0) {
                wrongQuestionsElement.innerHTML = `<span class="text-lg">ä½ ç­”éŒ¯äº†ç¬¬ ${wrongQuestions.join('ã€')} é¡Œ</span>`;
            } else {
                wrongQuestionsElement.innerHTML = '<span class="text-xl text-green-700">ğŸ‰ æ­å–œä½ ï¼å…¨éƒ¨ç­”å°äº†ï¼</span>';
            }
            
            document.querySelector('.result-box').style.display = 'block';
            document.querySelector('.result-box').scrollIntoView({ behavior: 'smooth' });

            // å‘¼å«å‡½å¼å‚³é€ç­”æ¡ˆåˆ° Google Sheet
            sendAnswersToGoogleSheet(userScore);
        }

        async function sendAnswersToGoogleSheet(finalScore) {
            const submitButton = document.getElementById('submit-btn');
            submitButton.innerText = 'æ­£åœ¨å‚³é€...';
            
            const quizTypeDisplay = document.getElementById('quiz-type-result').innerText;

            const dataToSend = {
                group: selectedGroup,
                name: selectedName,
                score: finalScore,
                quizType: quizTypeDisplay,
                // å°‡ç­”æ¡ˆé™£åˆ—è½‰æ›ç‚º JSON å­—ä¸²ä»¥ä¾¿ Apps Script è™•ç†
                answersJson: JSON.stringify(userAnswers) 
            };
            
            // å°‡ dataToSend è½‰æ›ç‚º URLSearchParams æ ¼å¼ï¼Œå› ç‚º Apps Script é€šå¸¸æœŸå¾…è¡¨å–®æ•¸æ“š
            const formBody = Object.keys(dataToSend).map(key => 
                encodeURIComponent(key) + '=' + encodeURIComponent(dataToSend[key])
            ).join('&');


            try {
                // ä½¿ç”¨ POST è«‹æ±‚ï¼Œmode: 'no-cors' æ˜¯ Apps Script å¸¸è¦‹çš„è¨­ç½®
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' 
                    },
                    body: formBody // å‚³é€ URL ç·¨ç¢¼çš„è¡¨å–®æ•¸æ“š
                });

                // ç”±æ–¼æ˜¯ no-cors æ¨¡å¼ï¼Œæˆ‘å€‘ç„¡æ³•ç›´æ¥è®€å– response.ok
                // å‡è¨­ fetch æˆåŠŸä¸”æ²’æœ‰æ‹‹å‡ºéŒ¯èª¤ï¼Œå‰‡å‚³é€æˆåŠŸ
                showMessage('ç­”æ¡ˆå·²æˆåŠŸå‚³é€åˆ° Google è©¦ç®—è¡¨ï¼', false);

            } catch (error) {
                console.error('å‚³é€ç­”æ¡ˆåˆ° Google è©¦ç®—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showMessage('å‚³é€ç­”æ¡ˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Apps Script è¨­å®šã€‚', true);
            } finally {
                submitButton.innerText = 'å·²å®Œæˆ';
                submitButton.disabled = true; // å³ä½¿å¤±æ•—ä¹Ÿä¿æŒç¦ç”¨ï¼Œé¿å…é‡è¤‡æäº¤
            }
        }

        window.onload = fetchTeamsData;
    </script>

</body>
</html>
